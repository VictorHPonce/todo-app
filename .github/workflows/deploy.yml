name: Deploy Laravel to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    - name: Deploy to VPS A
  run: |
    ssh vhpdev@164.132.230.125 << 'EOF'
      echo "🛰  Entrando a VPS y yendo a /var/www/laravel/todo-app"
      cd /var/www/laravel/todo-app

      echo "📦 Rama y último commit actual:"
      git status
      git log -1 --oneline

      echo "🔄 Haciendo reset + pull de main"
      git reset --hard HEAD
      git pull origin main

      echo "📦 Verificando contenido de routes/web.php"
      head -n 20 routes/web.php

      echo "⚙️ Ejecutando composer y Artisan"
      cp .env.production .env
      composer install --no-interaction --prefer-dist --optimize-autoloader

      php artisan migrate --force

      php artisan config:clear
      php artisan route:clear
      php artisan view:clear

      php artisan config:cache
      php artisan route:cache
      php artisan view:cache

      echo "♻️ Recargando servicios"
      sudo systemctl reload php8.3-fpm
      sudo systemctl reload nginx
    EOF
